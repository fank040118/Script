// ==UserScript==
// @name         Render LaTeX in NotebookLM (Precise Fix)
// @namespace    http://tampermonkey.net/
// @version      2.1.0
// @description  åŸºäºçœŸå®DOMç»“æ„çš„ç²¾å‡†ä¿®å¤
// @author       ergs0204 (with precise DOM structure fix)
// @match        https://notebooklm.google.com/*
// @grant        GM_addStyle
// @require      https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js
// @require      https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js
// @resource     katexCSS https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css
// @license      MIT
// ==/UserScript==

/* global renderMathInElement */

(function () {
    'use strict';

    const addKaTeXStyles = () => {
        const katexLink = document.createElement('link');
        katexLink.rel = 'stylesheet';
        katexLink.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css';
        document.head.appendChild(katexLink);
    };

    const addCustomStyles = () => {
        const css = `.katex { vertical-align: -0.1em; }`;
        GM_addStyle(css);
    };

    // ç²¾å‡†ä¿®å¤ï¼šåŸºäºçœŸå®çš„DOMç»“æ„
    const fixFragmentedLatex = (container) => {
        // æŸ¥æ‰¾æ‰€æœ‰classåŒ…å«"ng-star-inserted"çš„spanå…ƒç´ 
        const spans = Array.from(container.querySelectorAll('span.ng-star-inserted'));
        
        for (let i = 0; i < spans.length; i++) {
            const currentSpan = spans[i];
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯$$å¼€å§‹çš„span
            if (currentSpan.textContent.trim() === '$$') {
                console.log('[LaTeX Fix] å‘ç°$$å¼€å§‹æ ‡è®°');
                
                let latexContent = '$$';
                let endIndex = -1;
                let spansToRemove = [currentSpan];
                
                // å‘åæŸ¥æ‰¾åˆ°$$ç»“æŸæ ‡è®°
                for (let j = i + 1; j < spans.length; j++) {
                    const nextSpan = spans[j];
                    const nextText = nextSpan.textContent;
                    
                    spansToRemove.push(nextSpan);
                    
                    if (nextText.trim() === '$$') {
                        latexContent += '$$';
                        endIndex = j;
                        console.log('[LaTeX Fix] å‘ç°$$ç»“æŸæ ‡è®°');
                        break;
                    } else {
                        // æ·»åŠ å†…å®¹ï¼ˆåŒ…æ‹¬ç©ºæ ¼ï¼‰
                        latexContent += nextText;
                    }
                    
                    // å®‰å…¨é™åˆ¶ï¼šæœ€å¤šæŸ¥æ‰¾10ä¸ªspanï¼Œé¿å…æ— é™å¾ªç¯
                    if (j - i > 10) {
                        console.log('[LaTeX Fix] æŸ¥æ‰¾èŒƒå›´è¶…é™ï¼Œè·³è¿‡');
                        break;
                    }
                }
                
                // å¦‚æœæ‰¾åˆ°äº†å®Œæ•´çš„$$...$$ç»“æ„
                if (endIndex !== -1 && latexContent.length > 4) {
                    console.log('[LaTeX Fix] é‡æ„å…¬å¼:', latexContent);
                    
                    // åˆ›å»ºæ–°çš„åŒ…å«å®Œæ•´LaTeXçš„span
                    const newSpan = document.createElement('span');
                    newSpan.textContent = latexContent;
                    newSpan.className = 'latex-reconstructed ng-star-inserted';
                    
                    // æ’å…¥æ–°spanå¹¶ç§»é™¤æ—§çš„spans
                    currentSpan.parentNode.insertBefore(newSpan, currentSpan);
                    spansToRemove.forEach(span => span.remove());
                    
                    // æ›´æ–°å¾ªç¯ç´¢å¼•ï¼Œè·³è¿‡å·²å¤„ç†çš„spans
                    i = endIndex;
                    
                    // ä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªå…¬å¼ï¼Œé¿å…æ€§èƒ½é—®é¢˜
                    break;
                }
            }
        }
    };

    const preprocessAndSanitize = (node) => {
        if (node.nodeType === Node.TEXT_NODE) {
            let originalText = node.nodeValue;
            let newText = originalText;

            const displayMathRegex = /\$\$(.*?)\$\$/gs;
            let tempTextForDisplay = newText;
            let match_display;
            while ((match_display = displayMathRegex.exec(tempTextForDisplay)) !== null) {
                const content = match_display[1].trim();
                const isComplex = content.length > 25 || content.includes('\\begin') || content.includes('\\frac') || content.includes('\\sum') || content.includes('\\int') || content.includes('\\lim') || content.includes('\\\\') || content.split(' ').length > 4;
                if (!isComplex) {
                    newText = newText.replace(`$$${match_display[1]}$$`, `$${content}$`);
                }
            }

            if (newText !== originalText) {
                node.nodeValue = newText;
            }
        } else if (node.nodeType === Node.ELEMENT_NODE) {
            if (['SCRIPT', 'STYLE', 'TEXTAREA', 'PRE', 'CODE'].includes(node.tagName)) {
                return;
            }
            for (const child of Array.from(node.childNodes)) {
                preprocessAndSanitize(child);
            }
        }
    };

    const ignoreClass = 'katex-ignore-active-render';
    const katexOptions = {
        delimiters: [
            { left: "$$", right: "$$", display: true }, 
            { left: "$", right: "$", display: false },
            { left: "\\(", right: "\\)", display: false }, 
            { left: "\\[", right: "\\]", display: true }
        ],
        ignoredClasses: [ignoreClass, 'katex-display'],
        throwOnError: false
    };

    let renderTimeout;
    const renderPageWithIgnore = () => {
        const activeEl = document.activeElement;
        let hasIgnoreClass = false;
        try {
            if (activeEl && (activeEl.isContentEditable || activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'INPUT')) {
                activeEl.classList.add(ignoreClass);
                hasIgnoreClass = true;
            }
            
            // æ­¥éª¤1ï¼šä¿®å¤åˆ†ç‰‡çš„LaTeX
            fixFragmentedLatex(document.body);
            
            // æ­¥éª¤2ï¼šé¢„å¤„ç†
            preprocessAndSanitize(document.body);
            
            // æ­¥éª¤3ï¼šKaTeXæ¸²æŸ“
            renderMathInElement(document.body, katexOptions);
            
            console.log('[LaTeX Renderer] å®Œæ•´æ¸²æŸ“æµç¨‹å®Œæˆ');
        } catch (e) {
            console.error("KaTeX render error:", e);
        } finally {
            if (hasIgnoreClass && activeEl) {
                activeEl.classList.remove(ignoreClass);
            }
        }
    };

    // æ‰‹åŠ¨æ¸²æŸ“æŒ‰é’®
    const addManualRenderButton = () => {
        if (document.getElementById('latex-manual-render')) return;
        
        const button = document.createElement('button');
        button.id = 'latex-manual-render';
        button.textContent = 'ğŸ”„ ä¿®å¤LaTeX';
        button.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 10000;
            background: #4285f4; color: white; border: none;
            padding: 6px 10px; border-radius: 4px; cursor: pointer;
            font-size: 11px; font-family: sans-serif;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        `;
        button.onclick = () => {
            console.log('[LaTeX Renderer] === æ‰‹åŠ¨ä¿®å¤å¼€å§‹ ===');
            renderPageWithIgnore();
        };
        document.body.appendChild(button);
    };

    const observer = new MutationObserver(() => {
        clearTimeout(renderTimeout);
        renderTimeout = setTimeout(renderPageWithIgnore, 600);
    });
    observer.observe(document.body, { childList: true, subtree: true });

    window.addEventListener('load', () => {
        addKaTeXStyles();
        addCustomStyles();
        setTimeout(() => {
            renderPageWithIgnore();
            addManualRenderButton();
        }, 2000); // å»¶è¿Ÿ2ç§’ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
    });

})();